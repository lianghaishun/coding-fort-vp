# pnpm

`pnpm` 是一个现代的包管理工具，旨在通过创新的方式优化依赖安装和管理流程。它解决了传统包管理器（如 `npm` 和 `Yarn`）中的一些性能和磁盘空间使用问题，并引入了独特的<prib>“软链接”</prib>机制来提高效率。以下是关于 `pnpm` 的详细介绍，包括其特性、优势以及如何使用。

## 1.pnpm 的主要特点

### 1.1. **节省磁盘空间**

- **全局存储**：`pnpm` 使用一个全局存储区域（通常位于用户主目录下的 `.pnpm-store` 文件夹），所有安装的包都会被放置在这里。每个版本的包只会被下载一次。
- **符号链接**：当项目需要某个包时，`pnpm` 会在项目的 `node_modules` 目录中创建指向全局存储区域的符号链接，而不是复制整个包的内容。这大大减少了磁盘占用，并且加快了安装速度。

### 1.2. **快速安装**

- **并行下载**：类似于 `Yarn`，`pnpm` 支持并行下载多个包，从而显著缩短安装时间。
- **缓存优化**：由于采用了全局存储和符号链接策略，`pnpm` 在重复安装相同版本的包时可以立即完成，无需重新下载或解压。

### 1.3. **严格的依赖解析**

- **确定性安装**：每次运行 `pnpm install` 都会产生相同的结果，确保团队成员之间的一致性。
- **锁定文件**：`pnpm` 自动生成 `pnpm-lock.yaml` 文件，用于记录确切的依赖版本，防止意外更新带来的不兼容问题。

### 1.4. **工作区支持**

- **多包管理**：对于 monorepos 或包含多个子项目的大型项目，`pnpm` 提供了强大的工作区功能，允许在一个命令中同时处理多个包。
- **递归命令执行**：可以通过 `pnpm -r <command>` 在所有工作区内递归地执行命令，简化跨项目操作。

### 1.5. **插件系统**

- **可扩展性**：`pnpm` 拥有一个活跃的社区和丰富的插件生态系统，用户可以根据需要安装额外的功能模块。

<bwe>由于`pnmp` 会改动`node_modules` 目录结构，使得每个包只能使用直接依赖，而不能使用间接依赖。</bwe>

## 2.安装 pnpm

你可以通过多种方式安装 `pnpm`，最简单的方法是使用 npm：

```bash
npm install -g pnpm
```

或者，如果你已经安装了 Node.js，可以直接从 [pnpm 官方网站](https://pnpm.io/installation) 获取安装脚本：

```bash
curl -fsSL https://get.pnpm.io/install.sh | sh -
```

## 3.使用 pnpm

一旦安装完成，你就可以用 `pnpm` 来替代 `npm` 或 `Yarn` 执行各种命令。例如：

```bash
# 初始化项目
pnpm init

# 安装依赖
pnpm install

# 安装特定包
pnpm add <package-name>

# 安装开发依赖
pnpm add <package-name> --save-dev

# 运行脚本
pnpm run <script-name>
```

## 4.配置 pnpm

`pnpm` 默认配置通常已经足够满足大多数需求，但你也可以根据需要进行调整。例如：

```bash
# 设置默认注册表为官方 npm 源
pnpm config set registry https://registry.npmjs.org/

# 查看当前配置
pnpm config list
```

## 5.pnpm vs npm vs Yarn: 关键差异

| 特性             | npm                            | Yarn        | pnpm                             |
| ---------------- | ------------------------------ | ----------- | -------------------------------- |
| **安装速度**     | 较慢（早期版本），v5+ 显著提升 | 快速        | 非常快，得益于全局存储和符号链接 |
| **磁盘空间使用** | 较高                           | 中等        | 最低，通过全局存储和符号链接优化 |
| **锁定文件**     | `package-lock.json`（v5+）     | `yarn.lock` | `pnpm-lock.yaml`                 |
| **离线模式**     | 不支持                         | 支持        | 支持                             |
| **确定性安装**   | 依赖于 `package-lock.json`     | 内置特性    | 内置特性                         |
| **工作区支持**   | 需要额外配置                   | 内置支持    | 内置支持                         |

## 6.pnpm 原理

`pnpm` 是一种创新的包管理工具，它通过独特的依赖安装和存储机制来优化性能、磁盘空间使用以及依赖解析。以下是 `pnpm` 的工作原理及其背后的核心概念。

### 6.1.pnpm 的核心原理

#### 6.1.1. **全局存储（Global Store）**

- **单点存储**：`pnpm` 使用一个全局存储区域（通常位于用户主目录下的 `.pnpm-store` 文件夹），所有安装的包都会被放置在这里。每个版本的包只会被下载一次，并且可以被多个项目共享。
- **节省磁盘空间**：由于包只存一份副本，因此大大减少了磁盘占用。这对于拥有大量依赖项的大型项目尤其有利。

#### 6.1.2. **符号链接（Symbolic Links）**

- **高效引用**：当项目需要某个包时，`pnpm` 不会将整个包复制到项目的 `node_modules` 目录中，而是在那里创建指向全局存储区域中对应包的符号链接。这不仅加快了安装速度，还确保了不同项目之间的依赖一致性。

- **保留依赖树结构**：与 `npm` 和 `Yarn` 不同，`pnpm` 在项目的 `node_modules` 中保持了原始的依赖树结构。这意味着如果你在命令行中导入模块，路径将是直观的，如 `node_modules/dep1/node_modules/dep2`，而不是扁平化的结构。

#### 6.1.3. **严格的依赖解析**

- **确定性安装**：每次运行 `pnpm install` 都会产生相同的结果，确保团队成员之间的一致性。`pnpm` 自动生成 `pnpm-lock.yaml` 文件，用于记录确切的依赖版本，防止意外更新带来的不兼容问题。

- **锁定文件**：`pnpm-lock.yaml` 文件包含了详细的依赖信息，包括直接依赖和间接依赖的具体版本号。这保证了即使在不同的环境中，安装的依赖版本也是一致的。

#### 6.1.4. **并行化与缓存优化**

- **快速安装**：`pnpm` 支持并行下载多个包，从而显著缩短安装时间。同时，由于采用了全局存储和符号链接策略，重复安装相同版本的包可以立即完成，无需重新下载或解压。

- **缓存优化**：除了全局存储外，`pnpm` 还利用本地缓存来加速网络请求。如果曾经安装过某个包，即使没有网络连接也可以再次安装。

#### 6.1.5. **工作区支持**

- **多包管理**：对于 monorepos 或包含多个子项目的大型项目，`pnpm` 提供了强大的工作区功能，允许在一个命令中同时处理多个包。这简化了跨项目依赖管理和构建流程。

- **递归命令执行**：可以通过 `pnpm -r <command>` 在所有工作区内递归地执行命令，进一步提升了开发效率。

### 6.2.实现细节

#### 6.2.1.包安装流程

1. **解析依赖**：根据 `package.json` 和 `pnpm-lock.yaml` 文件解析项目所需的所有依赖项。
2. **检查全局存储**：查看全局存储是否已有该版本的包。如果有，则跳过下载步骤；如果没有，则从注册表下载并保存到全局存储。
3. **创建符号链接**：在项目的 `node_modules` 目录中为每个依赖项创建指向全局存储中相应位置的符号链接。
4. **更新锁定文件**：安装完成后，更新 `pnpm-lock.yaml` 文件以反映最新的依赖信息。

#### 6.2.2.解决依赖冲突

`pnpm` 采用了一种称为“虚拟 `node_modules`”的技术来解决依赖冲突。具体来说，它会在全局存储中为每个项目创建一个独立的虚拟 `node_modules` 目录，在其中组织依赖关系，从而避免了传统方式下可能出现的依赖版本冲突问题。

## 总结

`pnpm` 是一个高性能、节省资源并且易于使用的包管理工具，特别适合那些关心磁盘空间和安装速度的开发者。它的独特设计使得在大型项目或 monorepos 中管理依赖变得更加高效。如果你正在寻找一种更先进的解决方案来替代传统的 `npm` 或 `Yarn`，`pnpm` 可能是一个很好的选择。如果你还有更多关于 `pnpm` 的具体问题或需要进一步的帮助，请随时告诉我！
